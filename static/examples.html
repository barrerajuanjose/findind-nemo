<head>
    <title>Finding Nemo</title>
</head>
    <label for="sites">Site:</label>
    <select name="site" id="sites">
        <option value="MLB">MLB</option>
        <option value="MLA">MLA</option>
        <option value="MLM">MLM</option>
    </select>

    <br>

    <label for="itemtypes">Items:</label>
    <select name="it" id="itemtypes">
        <option value="">Cualquiera</option>
        <option value="to">Tienda Oficial</option>
        <option value="ds">Mejores vendedores</option>
        <option value="granel">Venta a granel</option>
        <option value="cpg">Supermercado</option>
        <option value="refurbished">Reacondicionado</option>
        <option value="manufacturing">Con tiempo de Manufactura (TODO)</option>
    </select>

    <br>

    <label for="variations">Variations:</label>
    <select name="variations" id="variations">
        <option value="">Cualquiera</option>
        <option value="one">Una</option>
        <option value="two">Dos</option>
        <option value="more">Más de 2</option>
    </select>

    <br>

    <label for="mercadopago">Mercado pago:</label>
    <select name="mp" id="mercadopago">
        <option value="">Cualquiera</option>
        <option value="pjs">Cuotas sin interes</option>
        <option value="installments">Con cuotas con y sin intereses</option>
        <option value="highestprice">Items con precios altos, no se pueden pagar con MP</option>
        <option value="lowestprice">Items con precios bajos</option>
    </select>

    <br>

    <label for="mercadoenvios">Mercado envios:</label>
    <select name="me" id="mercadoenvios">
        <option value="">Cualquiera</option>
        <option value="me2">Con ME</option>
        <option value="full">Full</option>
        <option value="puis">Envío sucursal (TODO)</option>
        <option value="cbt">Envio internacional (Solo MLB y MLM)</option>
    </select>

    <br>

    <label for="custom_query">Custom query:</label>
    <input type="text" id="custom_query">

    <br>

    <input type="button" onclick="getNemos()" value="Find It">

    <br>

    <div id="nemo_search">

    </div>

    <br>

    <div id="nemos" style="display: grid; grid-template-columns: repeat(2, 1fr);">
        <div id="nemo_sellers">

        </div>
        <div id="nemo_items">

        </div>
    </div>

    <script>
        function getNemos() {
            document.getElementById("nemo_search").innerHTML = "";
            document.getElementById("nemo_sellers").innerHTML = "";
            document.getElementById("nemo_items").innerHTML = "";

            let site = getSelectedValue("sites");
            let it = getSelectedValue("itemtypes");
            let mp = getSelectedValue("mercadopago");
            let me = getSelectedValue("mercadoenvios");
            let variations = getSelectedValue("variations");
            let custom_query = document.getElementById("custom_query").value;

            let url = "/search?site=" + site + "&it=" + it + "&mp=" + mp + "&me=" + me + "&variations=" + variations + "$cq=" + custom_query;

            fetch(url)
                .then(function (response) {
                    return response.json();
                })
                .then(function (result) {
                    let html = "<a href='" + result.search_url + "'>Search url</a><br>";
                    document.getElementById("nemo_search").innerHTML = html;

                    processSellersTypes(result.sellers_types)

                    processItems(result.items);
                })
                .catch(function (error) {
                    document.getElementById("nemo_items").innerHTML = error;
                });
        }

        function getSelectedValue(comboId) {
            let e = document.getElementById(comboId);
            return e.options[e.selectedIndex].value;
        }

        function processSellersTypes(sellers_types) {
            let html = "Sellers types:<br>";

            sellers_types.forEach(function(seller_type) {
                html += "<ul>";
                html += "<dt>" + seller_type.id + "</dt>";
                seller_type.sellers.forEach(function(seller) {
                    html += "<dd><a href='" + seller.search_url + "'>" + seller.id + "</a></dd>";
                });
                html += "</ul>";
            });

            document.getElementById("nemo_sellers").innerHTML = html;
        }

        function processItems(items) {
            let html = "Items ids:<br>";

            items.forEach(function(item) {
                html += getItemUrl(item);
            });

            document.getElementById("nemo_items").innerHTML = html;
        }

        function getItemUrl(item) {
            return "<a href='" + item.permalink + "'>" + item.id + "</a><br>";
        }
    </script>

    <br/>

    <h2>Ejemplos en MLB</h2>
    <a href='http://finding-nemo-jj.herokuapp.com/search?mp=psj&site=MLB'>Sem Juros</a><br/>
    <a href='http://finding-nemo-jj.herokuapp.com/search?mp=installments&site=MLB'>Con cuotas</a><br/>
    <a href='http://finding-nemo-jj.herokuapp.com/search?mp=highestprice&site=MLB'>Caros (Sin MP)</a><br/>
    <a href='http://finding-nemo-jj.herokuapp.com/search?mp=lowestprice&site=MLB'>Baratos</a><br/>
    <a href='http://finding-nemo-jj.herokuapp.com/search?me=full&site=MLB'>Full</a><br/>
    <a href='http://finding-nemo-jj.herokuapp.com/search?me=me2&site=MLB'>Con shipping</a><br/>
    <a href='http://finding-nemo-jj.herokuapp.com/search?it=to&site=MLB'>Tiendas Oficiales</a><br/>
    <a href='http://finding-nemo-jj.herokuapp.com/search?it=bs&site=MLB'>Mejores vendedores</a><br/>
    <a href='http://finding-nemo-jj.herokuapp.com/search?it=video&site=MLB'>Con videos</a><br/>
    <a href='http://finding-nemo-jj.herokuapp.com/search?it=granel&site=MLB'>Venta a granel</a><br/>
    <a href='http://finding-nemo-jj.herokuapp.com/search?it=manufacturing&site=MLB'>Tiempo manufactura</a><br/>
    <a href='http://finding-nemo-jj.herokuapp.com/search?me=cpg&site=MLB'>Envío internacional</a><br/>
</body>
